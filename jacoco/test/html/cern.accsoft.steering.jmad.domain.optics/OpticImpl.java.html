<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OpticImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jmad-core</a> &gt; <a href="index.source.html" class="el_package">cern.accsoft.steering.jmad.domain.optics</a> &gt; <span class="el_source">OpticImpl.java</span></div><h1>OpticImpl.java</h1><pre class="source lang-java linenums">// @formatter:off
 /*******************************************************************************
 *
 * This file is part of JMad.
 * 
 * Copyright (c) 2008-2011, CERN. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 ******************************************************************************/
// @formatter:on

package cern.accsoft.steering.jmad.domain.optics;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import cern.accsoft.steering.jmad.JMadConstants;
import cern.accsoft.steering.jmad.domain.elem.Element;
import cern.accsoft.steering.jmad.domain.types.enums.JMadPlane;
import cern.accsoft.steering.jmad.domain.var.enums.JMadTwissVariable;
import cern.accsoft.steering.jmad.domain.var.enums.MadxTwissVariable;
import cern.accsoft.steering.jmad.util.ListUtil;
import cern.accsoft.steering.jmad.util.ListUtil.Mapper;

/**
 * Represents a collection of values which can be referred to as the actual state of the optics of the accelerator. It
 * e.g. contains the values of the beta-functions, dispersions and reference orbits. The values can be retrieved in two
 * different manners: As objects representing the values at one element of the accelerator and as lists of values
 * representing all the values along the accelerator.
 * 
 * @author Kajetan Fuchsberger (kajetan.fuchsberger at cern.ch)
 */
<span class="fc" id="L46">public class OpticImpl implements Optic {</span>

    /** the element indizes by name */
<span class="fc" id="L49">    private final Map&lt;String, Integer&gt; indizes = new HashMap&lt;String, Integer&gt;();</span>

    /** all the optics points */
<span class="fc" id="L52">    private final List&lt;OpticPoint&gt; points = new ArrayList&lt;OpticPoint&gt;();</span>

    /** all the optics values as lists, just as from the tfs-result */
<span class="fc" id="L55">    private final Map&lt;MadxTwissVariable, List&lt;Double&gt;&gt; doubleLists = new HashMap&lt;MadxTwissVariable, List&lt;Double&gt;&gt;();</span>

    /** the names of the optics-points (Elements) */
<span class="fc" id="L58">    private List&lt;String&gt; names = new ArrayList&lt;String&gt;();</span>

    /**
     * adds values for all elements, representing the given variable
     * 
     * @param var the variable that defines the meaning of the values
     * @param values the values for all elements along the accelerator
     */
    public void add(MadxTwissVariable var, List&lt;Double&gt; values) {
<span class="fc" id="L67">        this.doubleLists.put(var, values);</span>
<span class="fc" id="L68">    }</span>

    /**
     * adds one optics point, which represents all values at one element
     * 
     * @param point the optics point to add
     */
    public void add(OpticPoint point) {
<span class="fc" id="L76">        points.add(point);</span>
<span class="fc" id="L77">        indizes.put(unifyKey(point.getName()), points.size() - 1);</span>
<span class="fc" id="L78">    }</span>

    @Override
    public List&lt;OpticPoint&gt; getAllPoints() {
<span class="nc" id="L82">        return points;</span>
    }

    @Override
    public OpticPoint getPointByName(String name) {
<span class="fc" id="L87">        Integer index = indizes.get(unifyKey(name));</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (index != null) {</span>
<span class="fc" id="L89">            return points.get(index);</span>
        }
<span class="nc" id="L91">        return null;</span>
    }

    @Override
    public OpticPoint getPoint(Element element) {
<span class="fc" id="L96">        return getPointByName(element.getName());</span>
    }

    /**
     * determines the index in the lists for the element of the given name
     * 
     * @param name the name of the element for which to get the index
     * @return the index
     */
    private Integer getIndex(String name) {
<span class="nc" id="L106">        return indizes.get(unifyKey(name));</span>
    }

    /**
     * creates a standard key which is used in the maps
     * 
     * @param key the key to unify
     * @return a key in a unified form
     */
    private static final String unifyKey(String key) {
<span class="fc" id="L116">        return key.toUpperCase(JMadConstants.DEFAULT_LOCALE);</span>
    }

    /**
     * converts a list of elements into a list of indizes
     * 
     * @param elements the elements whose indizes shall be determined
     * @return the names of the elements in a list
     */
    private final List&lt;Integer&gt; getElementIndizes(List&lt;Element&gt; elements) {
<span class="nc" id="L126">        return ListUtil.map(elements, new Mapper&lt;Element, Integer&gt;() {</span>

            @Override
            public Integer map(Element element) {
<span class="nc" id="L130">                return getIndex(element.getName());</span>
            }
        });
    }

    /**
     * determines the indizes for the elements of the given names
     * 
     * @param names the names of the elements for which to find the indizes
     * @return a list of indizes
     */
    private List&lt;Integer&gt; getIndizes(List&lt;String&gt; names) {
<span class="nc" id="L142">        return ListUtil.map(names, new Mapper&lt;String, Integer&gt;() {</span>

            @Override
            public Integer map(String name) {
<span class="nc" id="L146">                return getIndex(name);</span>
            }
        });
    }

    @Override
    public List&lt;Double&gt; getAllValues(MadxTwissVariable variable) {
<span class="fc" id="L153">        return this.doubleLists.get(variable);</span>
    }

    @Override
    public List&lt;Double&gt; getAllValues(JMadTwissVariable variable, JMadPlane plane) {
<span class="nc" id="L158">        return getAllValues(variable.getMadxTwissVariable(plane));</span>
    }

    /**
     * collects the optics points for the given indizes
     * 
     * @param pointIndizes the list-indizes of the points to collect
     * @return a list containing all the wanted optics-pointss
     */
    private List&lt;OpticPoint&gt; getPointsByIndizes(List&lt;Integer&gt; pointIndizes) {
<span class="nc" id="L168">        List&lt;OpticPoint&gt; foundPoints = new ArrayList&lt;OpticPoint&gt;();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        for (Integer index : pointIndizes) {</span>
<span class="nc" id="L170">            foundPoints.add(this.points.get(index));</span>
<span class="nc" id="L171">        }</span>
<span class="nc" id="L172">        return foundPoints;</span>
    }

    @Override
    public List&lt;OpticPoint&gt; getPoints(List&lt;Element&gt; elements) {
<span class="nc" id="L177">        return getPointsByIndizes(getElementIndizes(elements));</span>
    }

    @Override
    public List&lt;OpticPoint&gt; getPointsByNames(List&lt;String&gt; names) {
<span class="nc" id="L182">        return getPointsByIndizes(getIndizes(names));</span>
    }

    /**
     * collects all the values for the given variable and the given indizes in a list.
     * 
     * @param variable the variable for which to retrieve the values
     * @param pointIndizes the indizes of the optics points for which to find the values
     * @return a list of values
     */
    private List&lt;Double&gt; getValuesByIndizes(MadxTwissVariable variable, List&lt;Integer&gt; pointIndizes) {
<span class="nc" id="L193">        List&lt;Double&gt; allValues = getAllValues(variable);</span>
<span class="nc" id="L194">        List&lt;Double&gt; selectedValues = new ArrayList&lt;Double&gt;();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        for (Integer index : pointIndizes) {</span>
<span class="nc" id="L196">            selectedValues.add(allValues.get(index));</span>
<span class="nc" id="L197">        }</span>
<span class="nc" id="L198">        return selectedValues;</span>
    }

    @Override
    public List&lt;Double&gt; getValues(MadxTwissVariable variable, List&lt;Element&gt; elements) {
<span class="nc" id="L203">        return getValuesByIndizes(variable, getElementIndizes(elements));</span>
    }

    @Override
    public List&lt;Double&gt; getValues(JMadTwissVariable variable, JMadPlane plane, List&lt;Element&gt; elements) {
<span class="nc" id="L208">        return getValuesByIndizes(variable.getMadxTwissVariable(plane), getElementIndizes(elements));</span>
    }

    @Override
    public List&lt;Double&gt; getValuesByNames(MadxTwissVariable variable, List&lt;String&gt; names) {
<span class="nc" id="L213">        return getValuesByIndizes(variable, getIndizes(names));</span>
    }

    @Override
    public List&lt;Double&gt; getValuesByNames(JMadTwissVariable variable, JMadPlane plane, List&lt;String&gt; names) {
<span class="nc" id="L218">        return getValuesByIndizes(variable.getMadxTwissVariable(plane), getIndizes(names));</span>
    }

    @Override
    public List&lt;String&gt; getNames() {
<span class="nc" id="L223">        return this.names;</span>
    }

    public void setNames(List&lt;String&gt; names) {
<span class="fc" id="L227">        this.names = names;</span>
<span class="fc" id="L228">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>